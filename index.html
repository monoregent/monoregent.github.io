<!doctype html>
 	<html lang="en">
		<head>
		<meta charset="UTF-8">
		<title>Um titulo inteligente</title>
		<script type="text/javascript" >
		/*Quando o a pagina carregar esta função inicializa as variaveis globais*/
			
			function eventWindowLoaded () {	
 	      		c = document.getElementById("canvas");
	     	 	context = c.getContext("2d"); 
	      		document.getElementById("canvas").addEventListener('click', mousedown)
	      		document.getElementById("canvas").addEventListener('mousemove', biteTheDust)
	      		document.getElementById("canvas").addEventListener('contextmenu', rightClick )
	      		
		    	mode = "drawLine";
		    	numPontosLinha=0;
		    	tempPoints = [];
		    	tempLinesPoligonals = [];
		    	tempLinesPolygons = [];
		    	poligonals = [];
		    	points = [];
		    	lines = [];
		    	polygons = [];

		    	pickPointId = -1;
		    	pickLineId = -1;
		    	pickPoligonalId = -1;
		    	pickPolygonId = -1;
		   	}	

			function Ponto(x,y){
				this.x = x;
				this.y = y;
				
				return this;
			}

			function Linha(start, end){
				this.start = start;
				this.end = end;
				return this;
			}

			function Poligonal(lines){
				this.lines = lines;
				return this;
			}

			function Polygon(lines){
				this.lines = lines;
				return this;
			}
			incomplete = false;	
			

		    function pickMode(){
		    	mode="pickMode";
		    	biteTheDust();
		    }
		    function drawLineMode(){
		    	mode="drawLine";
		    	biteTheDust();
		    }

		    function drawPointMode(){
		    	mode="drawPoint";
		    	biteTheDust();
		    }

		    function drawPoligonalMode(){
		    	mode="drawPoligonal";
		    	biteTheDust();
		    }

		    function drawPolygonMode(){
		    	mode="drawPolygon";
		    	biteTheDust();
		    }

			function addClick(x,y){
				if (mode == "drawLine"){
					if(numPontosLinha % 2 == 0){
						tempPoints.push(new Ponto(x,y))
						numPontosLinha++;
						biteTheDust();
					}else{
						var tmpLinha = new Linha(new Ponto(tempPoints[0].x,tempPoints[0].y), new Ponto(x,y));
						lines.push(tmpLinha);						
						numPontosLinha ++;
						tempPoints = [];
						biteTheDust();
					}			
				}
		    }

			function mousedown(){
	    		var mousex = event.clientX-9;
	    		var mousey = event.clientY-9;
	    		if(mode=="drawLine"){
			    	addClick(mousex,mousey);
		    		biteTheDust();
		    	}else if(mode == "drawPoint"){
		    		points.push(new Ponto(mousex,mousey));
		    	}
		    	else if(mode == "drawPoligonal"){
	    			tempLinesPoligonals.push(new Ponto(mousex,mousey));
	    			incomplete = true;
	    			biteTheDust();
		    	}else if(mode == "drawPolygon"){
		    		tempLinesPolygons.push(new Ponto(mousex,mousey));
		    		incomplete = true;
		    		biteTheDust();
		    	}else if(mode == "pickMode"){
		    		pick();
		    	}
		    }

		    function pickPonto(tol){
		    	var px = event.clientX-9;
		    	var py = event.clientY-9;
		    	for(var i = 0;i<points.length;i++){	
		    		if(points[i].x>points[i].x-tol && points[i].x<px+tol && points[i].y>py-tol && points[i].y<py+tol){
		    			pickPointId = i;
		    			console.log("pick ponto " + i);
		    			return true;
		    		}
		    	}
		    }

		    function pickCode(x,y,xmin,xmax,ymin,ymax, cod){
				cod[0] = x < xmin;
			 	cod[1] = x > xmax;
				cod[2] = y < ymin;
				cod[3] = y > ymax;
			}
			//pick de linha usando cohen sutherland clipping
		    function pickLinha(tol){
		    	var px = event.clientX-9;
		    	var py = event.clientY-9;

		    	var xmin = px-tol;
		    	var xmax = px+tol;
		    	var ymin = py-tol;
		    	var ymax = py+tol;
		    	var cod0 = [];
		    	var cod1 = [];

		    	for(var i = 0; i<lines.length; i++){
		    		var x0 = lines[i].start.x;
		    		var x1 = lines[i].end.x;
					var y0 = lines[i].start.y;
					var y1 = lines[i].end.y;


		    		pickCode(x1, y1, xmin, xmax, ymin, ymax, cod1);
		    		//console.log(cod1);
		    		do{
		    			console.log("loop");
		    			pickCode(x0, y0, xmin, xmax, ymin, ymax, cod0);
		    			//console.log(cod0);
		    			for(var j = 0; j < 4; j++){
		    				if(cod0[j] && cod1[j]){
		    					break;
		    				}
		    			}
		    			if(j != 4){
		    				break;
		    			}
		    			if (cod0[0])
							y0 += (xmin - x0) * (y1 - y0) / (x1 - x0), x0 = xmin;
		    			
						else if (cod0[1])
							y0 += (xmax - x0) * (y1 - y0) / (x1 - x0), x0 = xmax;
						
						else if (cod0[2])
							x0 += (ymin - y0) * (x1 - x0) / (y1 - y0), y0 = ymin;
						
					    else if (cod0[3])
							x0 += (ymax - y0) * (x1 - x0) / (y1 - y0), y0 = ymax;
					    else{
					    	pickLineId = i;
							return 1;
					    }
						
					} while (1);

		    	}
		    	return -1;
		    }
		   function findAngle(p0,p1,p2) {
			    var b = Math.pow(p1.x-p0.x,2) + Math.pow(p1.y-p0.y,2),
			        a = Math.pow(p1.x-p2.x,2) + Math.pow(p1.y-p2.y,2),
			        c = Math.pow(p2.x-p0.x,2) + Math.pow(p2.y-p0.y,2);
			    return Math.acos( (a+b-c) / Math.sqrt(4*a*b) )*100 /Math.PI ;
			}

		    function pickPolygon(){
		    	
		    	var px = event.clientX-9;
		    	var py = event.clientY-9;

		    	for(var i =0; i<polygons.length;i++){
		    		var wn=0;
		    		for(var j = 0; j<polygons[i].length; j++){
			    		wn+=findAngle(polygons[i][j].start,new Ponto(px,py),polygons[i][j].end);
			    	}
			    	if(wn>180){
			    		pickPolygonId = i;
			    		return 1;
			    	}
		    	}
		    	return -1;
		    }	

		    function pick(){
		    	var px = event.clientX-9;
		    	var py = event.clientY-9;
		    	console.log("tentativa de pick");
		    	/*if(pickPonto(4)){
					return true;  
		    	}
		    	if(pickLinha(1)){
		    		//console.log(pickLineId);
		    		return true
		    	}*/
		    	if(pickPolygon()){
		    		console.log(pickPolygonId);
		    		return true;
		    	}

		    	
		    	
		    }

		    function rightClick(){
		    	if(mode == "drawPoligonal"){
			    	var poligonalTemp=[];
			    	for(var i = 0; i<tempLinesPoligonals.length-1; i++){
			    		poligonalTemp.push(new Linha(new Ponto(tempLinesPoligonals[i].x, tempLinesPoligonals[i].y), new Ponto(tempLinesPoligonals[i+1].x, tempLinesPoligonals[i+1].y)));
			    	}
			    	poligonalTemp.push(new Linha(new Ponto(tempLinesPoligonals[i].x, tempLinesPoligonals[i].y), new Ponto(event.clientX-9, event.clientY-9)));
			    	tempLinesPoligonals = [];
			    	poligonals.push(poligonalTemp);

			    }else if(mode == "drawPolygon"){
			    	var polygonTemp = [];
			    	for(var i = 0; i<tempLinesPolygons.length-1; i++){
			    		polygonTemp.push(new Linha(new Ponto(tempLinesPolygons[i].x, tempLinesPolygons[i].y), new Ponto(tempLinesPolygons[i+1].x, tempLinesPolygons[i+1].y)));
			    	}
			    	polygonTemp.push(new Linha(new Ponto(tempLinesPolygons[i].x, tempLinesPolygons[i].y), new Ponto(event.clientX-9, event.clientY-9)));
			    	polygonTemp.push(new Linha(new Ponto(event.clientX-9, event.clientY-9), new Ponto(tempLinesPolygons[0].x, tempLinesPolygons[0].y)));
			    	tempLinesPolygons = [];
			    	polygons.push(polygonTemp);
			    }
		    }


		    function biteTheDust(){
		    	context.clearRect(0, 0, canvas.width, canvas.height);
		    	c.strokeStyle = "#df4b26";
		    	c.lineWidth = 3;

		    	//Desenha pontos
		    	for(var i=0; i<points.length;i++){
		    		context.strokeRect(points[i].x, points[i].y, 1, 1);
		    	}
		    	//Desenha linhas
	    		for(var i=0;i<lines.length;i++){
	    			context.beginPath();
	    			context.moveTo(lines[i].start.x, lines[i].start.y);
	    			context.lineTo(lines[i].end.x,lines[i].end.y);
	    			context.stroke();
	    			context.fill();
					context.closePath();
	    		}
	    		//Desenha Poligonais
	    		for (var i = 0; i<poligonals.length; i++){
	    			context.beginPath();
	    			for(var j = 0; j< poligonals[i].length; j++){
	    				context.moveTo(poligonals[i][j].start.x, poligonals[i][j].start.y);
	    				context.lineTo(poligonals[i][j].end.x,poligonals[i][j].end.y);
	    			}
	    			context.stroke();
	    			context.fill();
					context.closePath();
	    		}

	    		//Desenha Poligonos
	    		for (var i = 0; i<polygons.length; i++){
	    			context.beginPath();
	    			for(var j = 0; j< polygons[i].length; j++){
	    				context.moveTo(polygons[i][j].start.x, polygons[i][j].start.y);
	    				context.lineTo(polygons[i][j].end.x,polygons[i][j].end.y);
	    			}
	    			context.stroke();
	    			context.fill();
					context.closePath();
	    		}

	    		//Desenha, se tiver, uma linha que esteja incompleta, ou seja, sendo desenhada pelo usuario.
	    		for(var i = 0; i<tempPoints.length;i++){
	    			context.beginPath();
	    			if(i == tempPoints.length-1){
	    				if(mode=="drawLine"){
	    					context.moveTo(tempPoints[i].x,tempPoints[i].y);
	    					if(numPontosLinha%2 == 0){
	    						context.moveTo(tempPoints[0].x,tempPoints[0].y);
	    						context.lineTo(tempPoints[1].x,tempPoints[1].y);
	    						numPontosLinha = 0;
	    						tempPoints = [];

	    					}else{
	    						context.lineTo(event.clientX-9,event.clientY-9);
	    					}
	    				}
	    			}else{
	    				context.moveTo(tempPoints[i].x,tempPoints[i].y);
	    				context.lineTo(tempPoints[i+1].x,tempPoints[i+1].y);
	    			}
	    			
	    			context.stroke();
	    			context.fill();
					context.closePath();
	    		}

	    		//Desenha, se tiver, uma poligonal que esteja incompleta, ou seja, sendo desenhada pelo usuario.
	    		for(var i = 0; i<tempLinesPoligonals.length; i++){
	    			context.beginPath();
	    			context.moveTo(tempLinesPoligonals[i].x, tempLinesPoligonals[i].y);
	    			if(i == tempLinesPoligonals.length-1){
	    				context.lineTo(event.clientX-9, event.clientY-9);
	    			}else{
	    				context.lineTo(tempLinesPoligonals[i+1].x, tempLinesPoligonals[i+1].y);
	    			}
	    			context.stroke();
	    			context.fill();
	    			context.closePath();
	    		}

	    		//Desenha, se tiver, um poligono que esteja incompleta, ou seja, sendo desenhada pelo usuario.
	    		for(var i = 0; i<tempLinesPolygons.length; i++){
	    			context.beginPath();
	    			context.moveTo(tempLinesPolygons[i].x, tempLinesPolygons[i].y);
	    			if(i == tempLinesPolygons.length-1){
	    				context.lineTo(event.clientX-9, event.clientY-9);
	    				context.stroke();
	    				context.fill();
	    				context.moveTo(tempLinesPolygons[0].x, tempLinesPolygons[0].y);
	    				context.lineTo(event.clientX-9, event.clientY-9);
	    				context.stroke();
	    				context.fill();
		    		}else{
	    				context.lineTo(tempLinesPolygons[i+1].x, tempLinesPolygons[i+1].y);
	    			}
	    			context.stroke();
	    			context.fill();
	    			context.closePath();
	    		}	
	    		context.closePath();
		    }
		
			window.addEventListener("load",eventWindowLoaded,false);
		</script>

		</head>
  	<body>
		<canvas id ="canvas" width="800" height="600" style="border:1px solid #000000;" oncontextmenu="return false;" > 
		</canvas>
		<button onclick="drawPointMode()">Draw Points</button> 		
		<button onclick="drawLineMode()">Draw Lines</button>
		<button onclick="drawPoligonalMode()">Draw Poligonals</button>
		<button onclick="drawPolygonMode()">Draw Polygons</button>
		<button onclick="pickMode()">Pick</button>

  	</body>
</html>
